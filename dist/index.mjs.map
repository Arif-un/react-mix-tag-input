{"version":3,"sources":["../src/MixInput.tsx","../src/utils.ts","../src/index.ts"],"sourcesContent":["import './MixInput.css'\r\n\r\nimport React, {\r\n  type ForwardedRef,\r\n  forwardRef,\r\n  type KeyboardEvent,\r\n  useEffect,\r\n  useImperativeHandle,\r\n  useRef,\r\n} from 'react'\r\n\r\nimport type { MixInputProps, MixInputRef, MixInputValue } from './MixInputType'\r\nimport { DEFAULT_TAG_CLASS, nodesToArray, tagValueArrToString } from './utils'\r\n\r\nconst MixInput = forwardRef((props: MixInputProps, ref: ForwardedRef<MixInputRef>) => {\r\n  const { onChange, value, multiline, ...restProps } = props\r\n  const contentRef = useRef(tagValueArrToString(value))\r\n  const editorRef = useRef<HTMLDivElement | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (!editorRef.current) return\r\n    editorRef.current.innerHTML = tagValueArrToString(value)\r\n  }, [value])\r\n\r\n  const insertContent = (newContent: MixInputValue) => {\r\n    const selection = window.getSelection()\r\n    if (!selection) {\r\n      return\r\n    }\r\n    const range = selection.getRangeAt(0)\r\n    range.deleteContents()\r\n\r\n    let node\r\n    if (typeof newContent === 'string') {\r\n      node = document.createTextNode(newContent)\r\n      node.textContent = newContent\r\n    } else if (typeof newContent === 'object' && newContent.type === 'tag') {\r\n      node = document.createElement('span')\r\n      node.classList.add(DEFAULT_TAG_CLASS)\r\n      if (newContent.classes) {\r\n        node.classList.add(newContent.classes)\r\n      }\r\n      node.setAttribute('contentEditable', 'false')\r\n      node.innerHTML = newContent.label\r\n    }\r\n\r\n    if (!node) {\r\n      console.error('invalid content')\r\n      return\r\n    }\r\n\r\n    range.insertNode(node)\r\n    const newRange = document.createRange()\r\n    newRange.setStartAfter(node)\r\n    newRange.setEndAfter(node)\r\n    selection.removeAllRanges()\r\n    selection.addRange(newRange)\r\n    editorRef.current?.focus()\r\n\r\n    contentRef.current = editorRef.current?.innerHTML ?? ''\r\n    onChange?.(nodesToArray(editorRef.current?.childNodes))\r\n  }\r\n\r\n  useImperativeHandle(ref, () => ({\r\n    inputRef: editorRef.current,\r\n    insertContent,\r\n    getValue: () => nodesToArray(editorRef.current?.childNodes),\r\n  }))\r\n\r\n  const handleContentChange = () => {\r\n    if (editorRef.current) {\r\n      contentRef.current = editorRef.current.innerHTML\r\n    }\r\n    onChange?.(nodesToArray(editorRef.current?.childNodes))\r\n  }\r\n\r\n  const handleKeyDown = (e: KeyboardEvent<HTMLDivElement>) => {\r\n    if (e.key === 'Enter' && !multiline) {\r\n      e.preventDefault()\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div\r\n      aria-label=\"input\"\r\n      role=\"textbox\"\r\n      tabIndex={0}\r\n      className=\"mix-tag-input\"\r\n      contentEditable={true}\r\n      ref={editorRef}\r\n      onInput={handleContentChange}\r\n      onKeyDown={handleKeyDown}\r\n      dangerouslySetInnerHTML={{ __html: contentRef.current }}\r\n      {...(multiline ? { 'aria-multiline': true } : {})}\r\n      {...restProps}\r\n    />\r\n  )\r\n})\r\n\r\nexport default MixInput\r\n","import { type MixTagValue } from './MixInputType'\r\n\r\nexport const DEFAULT_TAG_CLASS = 'mtag'\r\n\r\nexport function nodesToArray(nodes: NodeList | undefined): MixTagValue[] {\r\n  if (!nodes) return []\r\n\r\n  const nodeArr = Array.from(nodes)\r\n  const arr: MixTagValue[] = []\r\n\r\n  for (let i = 0; i < nodeArr.length; i += 1) {\r\n    const arrItem: Node | HTMLElement = nodeArr[i]\r\n    const lastItem: MixTagValue | undefined = arr.at(-1)\r\n    if (\r\n      arrItem instanceof Node &&\r\n      arrItem.nodeName === '#text' &&\r\n      arrItem.textContent !== '\\n' &&\r\n      arrItem.textContent !== ''\r\n    ) {\r\n      if (typeof lastItem === 'string') {\r\n        arr[arr.length - 1] = lastItem + arrItem.textContent\r\n      } else {\r\n        arr.push(arrItem.textContent || '')\r\n      }\r\n    }\r\n    if (arrItem instanceof HTMLElement && arrItem.nodeName === 'SPAN') {\r\n      const classes = arrItem?.classList?.value.replace(DEFAULT_TAG_CLASS, '').trim()\r\n      arr.push({\r\n        type: 'tag',\r\n        label: arrItem.innerHTML || arrItem.innerText,\r\n        ...(classes ? { classes } : {}),\r\n      })\r\n    }\r\n  }\r\n\r\n  return arr\r\n}\r\n\r\nexport function tagValueArrToString(valueArr: MixTagValue[] | undefined): string {\r\n  if (!Array.isArray(valueArr) || valueArr.length === 0) {\r\n    return ''\r\n  }\r\n\r\n  return valueArr.reduce((acc: string, item: MixTagValue) => {\r\n    if (typeof item === 'string') {\r\n      return (acc += item)\r\n    }\r\n    if (typeof item === 'object') {\r\n      const { label, classes } = item\r\n      return (acc += `<span class=\"${DEFAULT_TAG_CLASS} ${\r\n        classes || ''\r\n      }\" contenteditable=\"false\">${label}</span>`)\r\n    }\r\n    return ''\r\n  }, '')\r\n}\r\n\r\nexport function getCaretOffset(element: HTMLElement | null): number {\r\n  let caretOffset = 0\r\n  const sel = window.getSelection()\r\n\r\n  if (sel?.rangeCount && element) {\r\n    const range = sel.getRangeAt(0)\r\n    const preCaretRange = range.cloneRange()\r\n    preCaretRange.selectNodeContents(element)\r\n    preCaretRange.setEnd(range.endContainer, range.endOffset)\r\n    caretOffset = preCaretRange.toString().length\r\n  }\r\n  return caretOffset\r\n}\r\n","import MixInput from './MixInput'\r\nexport default MixInput\r\n"],"mappings":"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","names":["React","forwardRef","useEffect","useImperativeHandle","useRef","DEFAULT_TAG_CLASS","nodesToArray","nodes","_a","nodeArr","arr","i","arrItem","lastItem","classes","tagValueArrToString","valueArr","acc","item","label","MixInput","forwardRef","props","ref","onChange","value","multiline","restProps","contentRef","useRef","tagValueArrToString","editorRef","useEffect","insertContent","newContent","_a","_b","_c","selection","range","node","DEFAULT_TAG_CLASS","newRange","nodesToArray","useImperativeHandle","React","e","MixInput_default","src_default","MixInput_default"]}