"use client";
import K,{forwardRef as se,useId as de,useImperativeHandle as le,useLayoutEffect as J,useRef as ue,useState as Q}from"react";var R=1,Z=3,F={TAG:"tag",LINE_BREAK:"line-break"};function j(t){return typeof t=="object"&&t.type===F.TAG}function oe(t,r){var l,f,b,g,m,O;let n=Array.from(t.childNodes),e=r<0;if(!t)return{possibleCaretIndex:void 0,node:void 0,nodeIndex:void 0};if(e)return{possibleCaretIndex:0,node:e?n[0]:void 0,nodeIndex:e?n.length:void 0};if(N((l=n[0])==null?void 0:l.textContent)&&r===0)return{node:n.at(0),possibleCaretIndex:1,nodeIndex:0};let s=0,o=0;for(let T=0;T<n.length;T++){let x=n[T];if(x.nodeType!==R&&x.nodeType!==Z){console.error("invalid child node");continue}if(s+=((f=x.textContent)==null?void 0:f.length)||0,x.nodeType===Z&&s>=r)return{node:x,possibleCaretIndex:r-o,nodeIndex:T};if(x.nodeType===R&&s>=r){let B=N((b=n[T+1])==null?void 0:b.textContent);return{node:n[T+1],possibleCaretIndex:B?1:0,nodeIndex:T+1}}o+=((g=x.textContent)==null?void 0:g.length)||0}return{node:n.at(-1),nodeIndex:n.length-1,possibleCaretIndex:((O=(m=n.at(-1))==null?void 0:m.textContent)==null?void 0:O.length)||0}}function ie(t){let r=Object.keys(t);return r.length?r.reduce((n,e)=>n+=`${e}="${t[e]}" `,""):""}function ae({props:t,tagClassName:r,showTagDeleteBtn:n}){let{label:e,type:a,class:s,...o}=t;return a!=="tag"?"":`<span class="${r||""} ${s||""}" ${ie(o)}contenteditable="false">${e.trim()}${n?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>`}function N(t){return t==null||t===""?!1:t.charCodeAt(0)===8203}function W(t){return t.replace(/[\u200B]/g,"")}function $(t,r,n=!1){var l;if(!t)return;let{node:e,possibleCaretIndex:a}=oe(t,r);console.log("caret set target and possible",{targetCaretPos:r,possibleCaretIndex:a,node:e}),n&&((l=e==null?void 0:e.nextSibling)==null?void 0:l.nodeName)==="BR"&&(e=(e==null?void 0:e.nextSibling.nextSibling)||void 0,a=0);let s=document.createRange(),o=window.getSelection();!o||!e||a===void 0||(s.setStart(e,a),s.collapse(!0),o.removeAllRanges(),o.addRange(s))}function _(t){let r={range:void 0,isCaretInSameNode:void 0,endOffset:void 0,startOffset:void 0,startNode:void 0,endNode:void 0};if(!t||!window.getSelection)return r;let n=window.getSelection();if(t&&(n!=null&&n.rangeCount)&&n.rangeCount>0){let e=n.getRangeAt(0);return{range:e,isCaretInSameNode:e.endContainer===e.startContainer,endOffset:e.endOffset,startOffset:e.startOffset,startNode:e.startContainer,endNode:e.endContainer}}return r}function V(t){let r=document.createElement("DIV");return r.innerHTML=t,r.textContent||r.innerText||""}function z(t){let r=document.createElement("div");return r.innerHTML=t,r.innerHTML}function G(t){let r=0;if(window.getSelection){let n=window.getSelection();if(t&&(n!=null&&n.rangeCount)&&n.rangeCount>0){let e=n.getRangeAt(0),a=e.cloneRange();a.selectNodeContents(t),a.setEnd(e.endContainer,e.endOffset),r=a.toString().length}else return}else return;return r}function k({tagClassName:t,valueArr:r,showTagDeleteBtn:n=!1}){return Array.isArray(r)?r.length?(console.log("tag value to html"),r.reduce((e,a,s)=>{if(typeof a=="string")return e+=a;if(j(a)){let o=s===0,l=s===r.length-1,f=s>0&&j(r[s-1]);return(o||f)&&(e+="&ZeroWidthSpace;"),e+=ae({props:a,showTagDeleteBtn:n,tagClassName:t}),e+=l?"&ZeroWidthSpace;":"",console.log("==========================",e),e}return typeof a=="object"&&a.type==="line-break"?e+="<br>":""},"")):"":(console.error("[MixTagInput] Wrong value provided"),"")}function X(t,r=""){var a;if(!t)return[];let n=Array.from(t),e=[];for(let s=0;s<n.length;s+=1){let o=n[s],l=e.at(-1);if(o.nodeType===Z&&o instanceof Node&&o.textContent!==`
`&&o.textContent!==""&&W(o.textContent||"")!==""){let f=W(o.textContent||"");typeof l=="string"?e[e.length-1]=l+f:e.push(f||"")}if(o.nodeType===R&&o instanceof HTMLElement&&o.nodeName==="SPAN"){let f={};for(let b=0;b<o.attributes.length;b++){let g=o.attributes[b];if(g.nodeName==="class"){let m=(a=g.nodeValue)==null?void 0:a.replaceAll(new RegExp(r,"g"),"").trim();if(m==="")continue;if(m){f[g.nodeName]=m;continue}}g.nodeName!=="contenteditable"&&g.nodeName&&g.nodeValue&&(f[g.nodeName]=g.nodeValue)}e.push({type:F.TAG,label:o.textContent||"",...f})}o instanceof HTMLElement&&o.nodeName==="BR"&&e.push({type:F.LINE_BREAK})}return e}function q(t,r){return[t.slice(0,r),t.slice(r)]}var ce=se((t,r)=>{let{onChange:n,onInput:e,onKeyDown:a,onSelect:s,onFocus:o,value:l,placeholder:f,showTagDeleteBtn:b=!1,readonly:g=!1,tagClassName:m="mtag",...O}=t,T=de(),[x,B]=Q(""),u=ue(null),[L,v]=Q(999);l==null&&console.error("[MixInput] should have value prop but got undefined"),n===void 0&&console.error("[MixInput] should have onChange prop but got undefined"),le(r,()=>({element:u.current,caretPosition:L,insertContent:re})),J(()=>{D({triggerOnchange:!1,newHtmlContent:k({valueArr:l,showTagDeleteBtn:b,tagClassName:m})})},[l,m,b,k]),J(()=>{$(u.current,L)},[L]);let D=({newHtmlContent:d,triggerOnchange:h=!0}={})=>{var E;let i=u.current;if(!i)return;let y=d!==void 0,c=y?z(d):i.innerHTML,I=y?V(c):V(i.textContent||""),w=y&&N(x.charAt(1)),C=V(I).length-V(x).length;{let M=N(I.charAt(I.length-1)),H=L===I.length-1;M&&H&&(C+=1)}w&&(C=1);let A=c.endsWith("</span>"),p=c;A&&(p+="&ZeroWidthSpace;"),p.length-C<0&&(C=0),v(M=>p.length+C<0?0:M+C),B(p),h&&(n==null||n(X((E=u.current)==null?void 0:E.childNodes,m)))},Y=d=>{s==null||s(d);let h=G(u.current);typeof h=="number"&&v(h)},ee=d=>{var C,A,p,E;let h=d.key,{endNode:i,endOffset:y}=_(u.current),c=i==null?void 0:i.previousSibling,I=i==null?void 0:i.nextSibling,w=1;if(h==="ArrowLeft"&&i&&c&&N((C=i.textContent)==null?void 0:C.at(y-1))){d.preventDefault();let M=c.nodeName==="BR",H=c.nodeName==="SPAN";M&&v(S=>S-1),H&&v(S=>{var P;return S-((((P=c==null?void 0:c.textContent)==null?void 0:P.length)||0)+w)})}if(h==="ArrowRight"&&i&&I&&N((A=i.textContent)==null?void 0:A.at(y))){d.preventDefault();let M=I.nodeName==="BR",H=I.nodeName==="SPAN";M&&v(S=>S+1),H&&v(S=>{var P;return S+(((P=c==null?void 0:c.textContent)==null?void 0:P.length)||0)+w})}h==="Backspace"&&i&&N((p=i.textContent)==null?void 0:p.at(y-1))&&((E=i.previousSibling)==null?void 0:E.nodeType)===R&&u.current&&(d.preventDefault(),u.current.removeChild(i.previousSibling),i.textContent=W((i==null?void 0:i.textContent)||""),D()),h==="Enter"&&d.preventDefault(),a==null||a(d)},te=d=>{$(u.current,L),o==null||o(d)},ne=d=>{D(),e==null||e(d)};function re(d){let h=k({tagClassName:m,showTagDeleteBtn:b,valueArr:Array.isArray(d)?d:[d]}),{endNode:i,endOffset:y}=_(u.current),c=i===u.current;if(!u.current||!i||i==null||i===null)return;let[I,w]=q(i.textContent||"",y),C=document.createTextNode(I),A=document.createTextNode(w),p=document.createDocumentFragment(),E=document.createElement("DIV");E.innerHTML=h,p.append(C),Array.from(E.childNodes).map(M=>p.append(M)),p.append(A),p.normalize(),c?u.current.append(p):u.current.replaceChild(p,i),D()}return K.createElement(K.Fragment,null,K.createElement("div",{key:`${T}-mix-input`,"data-placeholder":f,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!g,ref:u,onInput:ne,onKeyDown:ee,onSelect:Y,onFocus:te,dangerouslySetInnerHTML:{__html:x},...O}))}),U=ce;var Ie=U;export{Ie as default};
//# sourceMappingURL=index.mjs.map