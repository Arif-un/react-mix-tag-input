"use client";
import re,{forwardRef as ae,useEffect as W,useId as oe,useImperativeHandle as se,useRef as V}from"react";var K="mtag",H={TAG:"tag",LINE_BREAK:"line-break"};function v(r,f,o=!1){var c,d;if(!r)return[];let a=Array.from(r),e=[];for(let x=0;x<a.length;x+=1){let s=a[x],b=e.at(-1);if(s instanceof Node&&s.nodeName==="#text"&&s.textContent!==`
`&&s.textContent!==""){let E=ee(s.textContent||"");typeof b=="string"?e[e.length-1]=b+E:e.push(E||"")}if(s instanceof HTMLElement&&s.nodeName==="SPAN"){let E=(c=s==null?void 0:s.classList)==null?void 0:c.value.replace(K,"").trim(),h=((d=s==null?void 0:s.dataset)==null?void 0:d.id)||"";e.push({...o?{tagId:h}:{},type:H.TAG,label:s.innerHTML||s.innerText,...E?{classes:E}:{},...f.current[h]?{data:f.current[h]}:{}})}s instanceof HTMLElement&&s.nodeName==="BR"&&e.push({type:H.LINE_BREAK})}return e}function ee(r){return r.replace(/[\u200B]/g,"")}function te({classes:r,text:f,id:o,showTagDeleteBtn:a}){return`<span data-id="${o}" class="${K} ${r}" contenteditable="false">${f.trim()}${a?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function P({valueArr:r,showTagDeleteBtn:f=!1,tagsDataRef:o,componentId:a}){return!Array.isArray(r)||r.length===0?"":r.reduce((e,c)=>{if(typeof c=="string")return e+=c;if(I(c)){let{label:d,classes:x,data:s}=c,b=j(a);return s&&(o.current[b]=s),e+=te({classes:x||"",text:d,id:b,showTagDeleteBtn:f})}return typeof c=="object"&&c.type==="line-break"?e+="<br>":""},"")}function j(r){let f=Date.now().toString(36),o=Math.random().toString(36).substr(2);return r+f+o}function G({componentId:r,tagsDataRef:f,showTagDeleteBtn:o,data:a}){let e=document.createElement("span");e.setAttribute("contentEditable","false");let c=j(r);if(e.setAttribute("data-id",c),e.classList.add(K),e.innerHTML=a.label,a.classes&&e.classList.add(a.classes),a.data&&(f.current[c]=a.data,e.setAttribute("data-id",c)),o){let d=document.createElement("button");d.classList.add("mtag-delete-btn"),d.setAttribute("contentEditable","false"),d.setAttribute("tabIndex","-1"),d.innerHTML="&times;",e.appendChild(d)}return e}function $(r,f){var c;if(!r)return{foundNode:void 0,nodeIndex:0};let o=null,a=0,e=Array.from(r.childNodes);for(let d=0;d<e.length;d++){let x=e[d];if(x!=null&&x.textContent){let s=x.textContent.length;if(a+s>=f){o=x;break}a+=s}}return o||(o=e.at(-1),a=((c=o==null?void 0:o.textContent)==null?void 0:c.length)||0),{foundNode:o,nodeIndex:a}}function I(r){return typeof r=="object"&&r.type===H.TAG}function ne(r){return typeof r=="object"&&r.type===H.LINE_BREAK}function q({item:r,componentId:f,tagsDataRef:o,showTagDeleteBtn:a}){if(typeof r=="string"){let e=document.createTextNode(r);return e.textContent=r,e}else{if(I(r))return G({componentId:f,tagsDataRef:o,data:r,showTagDeleteBtn:a});if(ne(r))return document.createElement("br");if(Array.isArray(r))return r.map(e=>{if(typeof e=="string"){let c=document.createTextNode(e);return c.textContent=e,c}else if(I(e))return G({componentId:f,tagsDataRef:o,data:e,showTagDeleteBtn:a})}).reverse()}}var ie=ae((r,f)=>{let o=oe(),a=V({}),{onChange:e,onClick:c,value:d,multiline:x,placeholder:s,showTagDeleteBtn:b=!0,readonly:E=!1,onPaste:h,onKeyDown:D,onSelect:w,onFocus:k,...U}=r,B=V(P({componentId:o,tagsDataRef:a,valueArr:d,showTagDeleteBtn:b})),i=V(null),m=V(0);W(()=>{i.current&&(i.current.innerHTML=P({componentId:o,tagsDataRef:a,valueArr:d,showTagDeleteBtn:b}))},[d]);let F=t=>{var y,S,L,T;let l=window.getSelection();if(!l)return;let n=l.getRangeAt(0);if(n.commonAncestorContainer!==i.current&&n.commonAncestorContainer.parentElement!==i.current)return;n.deleteContents();let u=q({item:t,componentId:o,tagsDataRef:a,showTagDeleteBtn:b}),g=0;if(Array.isArray(u)?u.forEach(p=>{var M;p&&(p.nodeName!=="BR"&&(g+=((M=p.textContent)==null?void 0:M.length)||0),p.nodeName==="SPAN"&&(g+=1),n.insertNode(p),n.setEndAfter(p))}):u&&(u.nodeName!=="BR"&&(g+=((y=u.textContent)==null?void 0:y.length)||0),u.nodeName==="SPAN"&&(g+=1),n.insertNode(u),n.setEndAfter(u)),!u){console.error("invalid content");return}B.current=((S=i.current)==null?void 0:S.innerHTML)??"",m.current+=g,(L=i.current)==null||L.focus(),e==null||e(v((T=i.current)==null?void 0:T.childNodes,a))};se(f,()=>({inputRef:i.current,insertContent:F,getValue:()=>{var t;return v((t=i.current)==null?void 0:t.childNodes,a)}}));let z=()=>{var t;i.current&&(B.current=i.current.innerHTML),e==null||e(v((t=i.current)==null?void 0:t.childNodes,a))},J=t=>{var l,n,u,g,y,S,L;if(D==null||D(t),t.key==="Enter"&&!x)t.preventDefault();else if(t.key==="Enter"&&x){t.preventDefault(),F({type:"line-break"});return}else if(t.key==="Backspace"){let{node:T,charCode:p}=_(O()),M=null;if(((l=T==null?void 0:T.previousSibling)==null?void 0:l.nodeName)==="SPAN"){let A=T==null?void 0:T.previousSibling;M=(n=A.getAttribute)==null?void 0:n.call(A,"data-id")}if(M&&p===8203){t.preventDefault();let A=v((u=i.current)==null?void 0:u.childNodes,a,!0),{label:R}=A.find(C=>I(C)&&(C==null?void 0:C.tagId)===M),X=A.filter(C=>!(I(C)&&C.tagId===M)),Y=P({valueArr:X,componentId:o,showTagDeleteBtn:b,tagsDataRef:a});i!=null&&i.current&&(i.current.innerHTML=Y),N(m.current-R.length-1)}m.current-=1;return}else if(t.key==="ArrowLeft"){let{node:T,charCode:p}=_(m.current),M=T==null?void 0:T.previousSibling,A=(g=M.getAttribute)==null?void 0:g.call(M,"data-id");if(A&&p===8203){t.preventDefault();let R=(y=i.current)==null?void 0:y.querySelector(`[data-id="${A}"]`);N(m.current-(((S=R==null?void 0:R.textContent)==null?void 0:S.length)||0)-1)}return}else if(t.key==="ArrowRight"){let T=m.current+1,{node:p}=_(T);(p==null?void 0:p.nodeName)==="SPAN"&&(t.preventDefault(),N(m.current+(((L=p==null?void 0:p.textContent)==null?void 0:L.length)||0)+1));return}else t.key!=="Delete"&&t.key!=="Tab"&&(m.current+=1)},Q=t=>{var l,n,u;t.target instanceof HTMLButtonElement&&t.target.classList.contains("mtag-delete-btn")&&((n=(l=t.target)==null?void 0:l.parentElement)==null||n.remove(),e==null||e(v((u=i.current)==null?void 0:u.childNodes,a))),c==null||c(t)};function O(){let t=0;if(window.getSelection){let l=window.getSelection();if(i.current&&(l!=null&&l.rangeCount)&&l.rangeCount>0){let n=l.getRangeAt(0),u=n.cloneRange();u.selectNodeContents(i.current),u.setEnd(n.endContainer,n.endOffset),t=u.toString().length}}return t}W(()=>{N(m.current)},[m.current,d]);function N(t){let l=t;if(!i.current)return;let{foundNode:n,nodeIndex:u}=$(i.current,l);if(n!=null&&n.textContent){let g=document.createRange(),y=window.getSelection();if(!y)return;n!=null&&n.textContent&&(n==null?void 0:n.textContent.length)>=l-u?g.setStart(n,l-u):g.setStart(n,n.textContent.length),g.collapse(!0),y.removeAllRanges(),y.addRange(g),m.current=t}}function _(t){let l=t,{foundNode:n,nodeIndex:u}=$(i.current,l);if(n!=null&&n.textContent){let g=l-u-1,y=n.textContent[g];return{charCode:y==null?void 0:y.charCodeAt(0),node:n,nodeIndex:u,index:g}}return{}}return re.createElement("div",{"data-placeholder":s,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!E,ref:i,onInput:z,onKeyDown:J,onClick:Q,onSelect:t=>{w==null||w(t),m.current=O()},onPaste:t=>{t.preventDefault();let n=t.clipboardData.getData("text/plain");F(n),h==null||h(t)},onFocus:t=>{N(m.current),k==null||k(t)},dangerouslySetInnerHTML:{__html:B.current},...x?{"aria-multiline":!0}:{},...U})}),Z=ie;var Me=Z;export{Me as default};
//# sourceMappingURL=index.mjs.map