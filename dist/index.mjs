"use client";
import re,{forwardRef as ae,useEffect as W,useId as oe,useImperativeHandle as se,useRef as D}from"react";var K="mtag",H={TAG:"tag",LINE_BREAK:"line-break"};function N(r,p,o=!1){var c,d;if(!r)return[];let a=Array.from(r),t=[];for(let T=0;T<a.length;T+=1){let s=a[T],M=t.at(-1);if(s instanceof Node&&s.nodeName==="#text"&&s.textContent!==`
`&&s.textContent!==""){let E=ee(s.textContent||"");typeof M=="string"?t[t.length-1]=M+E:t.push(E||"")}if(s instanceof HTMLElement&&s.nodeName==="SPAN"){let E=(c=s==null?void 0:s.classList)==null?void 0:c.value.replace(K,"").trim(),C=((d=s==null?void 0:s.dataset)==null?void 0:d.id)||"";t.push({...o?{tagId:C}:{},type:H.TAG,label:s.innerHTML||s.innerText,...E?{classes:E}:{},...p.current[C]?{data:p.current[C]}:{}})}s instanceof HTMLElement&&s.nodeName==="BR"&&t.push({type:H.LINE_BREAK})}return t}function ee(r){return r.replace(/[\u200B]/g,"")}function te({classes:r,text:p,id:o,showTagDeleteBtn:a}){return`<span data-id="${o}" class="${K} ${r}" contenteditable="false">${p.trim()}${a?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function V({valueArr:r,showTagDeleteBtn:p=!1,tagsDataRef:o,componentId:a}){return!Array.isArray(r)||r.length===0?"":r.reduce((t,c)=>{if(typeof c=="string")return t+=c;if(v(c)){let{label:d,classes:T,data:s}=c,M=j(a);return s&&(o.current[M]=s),t+=te({classes:T||"",text:d,id:M,showTagDeleteBtn:p})}return typeof c=="object"&&c.type==="line-break"?t+="<br>":""},"")}function j(r){let p=Date.now().toString(36),o=Math.random().toString(36).substr(2);return r+p+o}function G({componentId:r,tagsDataRef:p,showTagDeleteBtn:o,data:a}){let t=document.createElement("span");t.setAttribute("contentEditable","false");let c=j(r);if(t.setAttribute("data-id",c),t.classList.add(K),t.innerHTML=a.label,a.classes&&t.classList.add(a.classes),a.data&&(p.current[c]=a.data,t.setAttribute("data-id",c)),o){let d=document.createElement("button");d.classList.add("mtag-delete-btn"),d.setAttribute("contentEditable","false"),d.setAttribute("tabIndex","-1"),d.innerHTML="&times;",t.appendChild(d)}return t}function $(r,p){var c;if(!r)return{foundNode:void 0,nodeIndex:0};let o=null,a=0,t=Array.from(r.childNodes);for(let d=0;d<t.length;d++){let T=t[d];if(T!=null&&T.textContent){let s=T.textContent.length;if(a+s>=p){o=T;break}a+=s}}return o||(o=t.at(-1),a=((c=o==null?void 0:o.textContent)==null?void 0:c.length)||0),{foundNode:o,nodeIndex:a}}function v(r){return typeof r=="object"&&r.type===H.TAG}function ne(r){return typeof r=="object"&&r.type===H.LINE_BREAK}function q({item:r,componentId:p,tagsDataRef:o,showTagDeleteBtn:a}){if(typeof r=="string"){let t=document.createTextNode(r);return t.textContent=r,t}else{if(v(r))return G({componentId:p,tagsDataRef:o,data:r,showTagDeleteBtn:a});if(ne(r))return document.createElement("br");if(Array.isArray(r))return r.map(t=>{if(typeof t=="string"){let c=document.createTextNode(t);return c.textContent=t,c}else if(v(t))return G({componentId:p,tagsDataRef:o,data:t,showTagDeleteBtn:a})}).reverse()}}var ie=ae((r,p)=>{let o=oe(),a=D({}),{onChange:t,onClick:c,value:d,multiline:T,placeholder:s,showTagDeleteBtn:M=!0,readonly:E=!1,onPaste:C,onKeyDown:w,onSelect:k,onFocus:B,...U}=r,F=D(V({componentId:o,tagsDataRef:a,valueArr:d,showTagDeleteBtn:M})),i=D(null),f=D(0);W(()=>{i.current&&(i.current.innerHTML=V({componentId:o,tagsDataRef:a,valueArr:d,showTagDeleteBtn:M}))},[d]);let _=e=>{var y,S,L,m;let l=window.getSelection();if(!l)return;let n=l.getRangeAt(0);if(n.commonAncestorContainer!==i.current&&n.commonAncestorContainer.parentElement!==i.current)return;n.deleteContents();let u=q({item:e,componentId:o,tagsDataRef:a,showTagDeleteBtn:M}),x=0;if(Array.isArray(u)?u.forEach(g=>{var b;g&&(g.nodeName!=="BR"&&(x+=((b=g.textContent)==null?void 0:b.length)||0),g.nodeName==="SPAN"&&(x+=1),n.insertNode(g),n.setEndAfter(g))}):u&&(u.nodeName!=="BR"&&(x+=((y=u.textContent)==null?void 0:y.length)||0),u.nodeName==="SPAN"&&(x+=1),n.insertNode(u),n.setEndAfter(u)),!u){console.error("invalid content");return}F.current=((S=i.current)==null?void 0:S.innerHTML)??"",f.current+=x,(L=i.current)==null||L.focus(),t==null||t(N((m=i.current)==null?void 0:m.childNodes,a))};se(p,()=>({inputRef:i.current,insertContent:_,getValue:()=>{var e;return N((e=i.current)==null?void 0:e.childNodes,a)},setCaret:e=>h(e),caretPosition:f.current}));let z=()=>{var e;i.current&&(F.current=i.current.innerHTML),t==null||t(N((e=i.current)==null?void 0:e.childNodes,a))},J=e=>{var l,n,u,x,y,S,L;if(w==null||w(e),e.key==="Enter"&&!T)e.preventDefault();else if(e.key==="Enter"&&T){e.preventDefault(),_({type:"line-break"});return}else if(e.key==="Backspace"){let{node:m,charCode:g}=P(O()),b=null;if(((l=m==null?void 0:m.previousSibling)==null?void 0:l.nodeName)==="SPAN"){let A=m==null?void 0:m.previousSibling;b=(n=A.getAttribute)==null?void 0:n.call(A,"data-id")}if(b&&g===8203){e.preventDefault();let A=N((u=i.current)==null?void 0:u.childNodes,a,!0),{label:R}=A.find(I=>v(I)&&(I==null?void 0:I.tagId)===b),X=A.filter(I=>!(v(I)&&I.tagId===b)),Y=V({valueArr:X,componentId:o,showTagDeleteBtn:M,tagsDataRef:a});i!=null&&i.current&&(i.current.innerHTML=Y),h(f.current-R.length-1)}else f.current>0&&(f.current-=1);return}else if(e.key==="ArrowLeft"){let{node:m,charCode:g}=P(f.current),b=m==null?void 0:m.previousSibling,A=(x=b==null?void 0:b.getAttribute)==null?void 0:x.call(b,"data-id");if(A&&g===8203){e.preventDefault();let R=(y=i.current)==null?void 0:y.querySelector(`[data-id="${A}"]`);h(f.current-(((S=R==null?void 0:R.textContent)==null?void 0:S.length)||0)-1)}return}else if(e.key==="ArrowRight"){let m=f.current+1,{node:g}=P(m);(g==null?void 0:g.nodeName)==="SPAN"&&(e.preventDefault(),h(f.current+(((L=g==null?void 0:g.textContent)==null?void 0:L.length)||0)+1));return}else e.key!=="Delete"&&e.key!=="Tab"&&(f.current+=1)},Q=e=>{var l,n,u;e.target instanceof HTMLButtonElement&&e.target.classList.contains("mtag-delete-btn")&&((n=(l=e.target)==null?void 0:l.parentElement)==null||n.remove(),t==null||t(N((u=i.current)==null?void 0:u.childNodes,a))),c==null||c(e)};function O(){let e=0;if(window.getSelection){let l=window.getSelection();if(i.current&&(l!=null&&l.rangeCount)&&l.rangeCount>0){let n=l.getRangeAt(0),u=n.cloneRange();u.selectNodeContents(i.current),u.setEnd(n.endContainer,n.endOffset),e=u.toString().length}}return e}W(()=>{h(f.current)},[f.current,d]);function h(e){let l=e;if(!i.current)return;let{foundNode:n,nodeIndex:u}=$(i.current,l);if(n!=null&&n.textContent){let x=document.createRange(),y=window.getSelection();if(!y)return;n!=null&&n.textContent&&(n==null?void 0:n.textContent.length)>=l-u?x.setStart(n,l-u):x.setStart(n,n.textContent.length),x.collapse(!0),y.removeAllRanges(),y.addRange(x),f.current=e}}function P(e){let l=e,{foundNode:n,nodeIndex:u}=$(i.current,l);if(n!=null&&n.textContent){let x=l-u-1,y=n.textContent[x];return{charCode:y==null?void 0:y.charCodeAt(0),node:n,nodeIndex:u,index:x}}return{}}return re.createElement("div",{"data-placeholder":s,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!E,ref:i,onInput:z,onKeyDown:J,onClick:Q,onSelect:e=>{k==null||k(e),f.current=O();let{charCode:l}=P(f.current+1);l===8203&&(f.current+=1,h(f.current))},onPaste:e=>{e.preventDefault();let n=e.clipboardData.getData("text/plain");_(n),C==null||C(e)},onFocus:e=>{h(f.current),B==null||B(e)},dangerouslySetInnerHTML:{__html:F.current},...T?{"aria-multiline":!0}:{},...U})}),Z=ie;var be=Z;export{be as default};
//# sourceMappingURL=index.mjs.map