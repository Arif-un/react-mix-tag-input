"use client";
import ne,{forwardRef as re,useEffect as W,useId as ae,useImperativeHandle as oe,useRef as H}from"react";var K="mtag",v={TAG:"tag",LINE_BREAK:"line-break"};function S(o,g,u=!1){var l,d;if(!o)return[];let r=Array.from(o),n=[];for(let f=0;f<r.length;f+=1){let s=r[f],E=n.at(-1);if(s instanceof Node&&s.nodeName==="#text"&&s.textContent!==`
`&&s.textContent!==""){let A=ee(s.textContent||"");typeof E=="string"?n[n.length-1]=E+A:n.push(A||"")}if(s instanceof HTMLElement&&s.nodeName==="SPAN"){let A=(l=s==null?void 0:s.classList)==null?void 0:l.value.replace(K,"").trim(),h=((d=s==null?void 0:s.dataset)==null?void 0:d.id)||"";n.push({...u?{tagId:h}:{},type:v.TAG,label:s.innerHTML||s.innerText,...A?{classes:A}:{},...g.current[h]?{data:g.current[h]}:{}})}s instanceof HTMLElement&&s.nodeName==="BR"&&n.push({type:v.LINE_BREAK})}return n}function ee(o){return o.replace(/[\u200B]/g,"")}function te({classes:o,text:g,id:u,showTagDeleteBtn:r}){return`<span data-id="${u}" class="${K} ${o}" contenteditable="false">${g.trim()}${r?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function D({valueArr:o,showTagDeleteBtn:g=!1,tagsDataRef:u,componentId:r}){return!Array.isArray(o)||o.length===0?"":o.reduce((n,l)=>{if(typeof l=="string")return n+=l;if(C(l)){let{label:d,classes:f,data:s}=l,E=j(r);return s&&(u.current[E]=s),n+=te({classes:f||"",text:d,id:E,showTagDeleteBtn:g})}return typeof l=="object"&&l.type==="line-break"?n+="<br>":""},"")}function j(o){let g=Date.now().toString(36),u=Math.random().toString(36).substr(2);return o+g+u}function G({componentId:o,tagsDataRef:g,showTagDeleteBtn:u,data:r}){let n=document.createElement("span");n.setAttribute("contentEditable","false");let l=j(o);if(n.setAttribute("data-id",l),n.classList.add(K),n.innerHTML=r.label,r.classes&&n.classList.add(r.classes),r.data&&(g.current[l]=r.data,n.setAttribute("data-id",l)),u){let d=document.createElement("button");d.classList.add("mtag-delete-btn"),d.setAttribute("contentEditable","false"),d.setAttribute("tabIndex","-1"),d.innerHTML="&times;",n.appendChild(d)}return n}function $(o,g){var l;if(!o)return{foundNode:void 0,nodeIndex:0};let u=null,r=0,n=Array.from(o.childNodes);for(let d=0;d<n.length;d++){let f=n[d];if(f!=null&&f.textContent){let s=f.textContent.length;if(r+s>=g){u=f;break}r+=s}}return u||(u=n.at(-1),r=((l=u==null?void 0:u.textContent)==null?void 0:l.length)||0),{foundNode:u,nodeIndex:r}}function C(o){return typeof o=="object"&&o.type===v.TAG}function q(o){return typeof o=="object"&&o.type===v.LINE_BREAK}var se=re((o,g)=>{let u=ae(),r=H({}),{onChange:n,onClick:l,value:d,multiline:f,placeholder:s,showTagDeleteBtn:E=!0,readonly:A=!1,onPaste:h,onKeyDown:V,onSelect:k,onFocus:B,...U}=o,w=H(D({componentId:u,tagsDataRef:r,valueArr:d,showTagDeleteBtn:E})),i=H(null),T=H(0);W(()=>{i.current&&(i.current.innerHTML=D({componentId:u,tagsDataRef:r,valueArr:d,showTagDeleteBtn:E}))},[d]);let _=e=>{var R,N,p,m;let c=window.getSelection();if(!c)return;let t=c.getRangeAt(0);if(t.commonAncestorContainer!==i.current&&t.commonAncestorContainer.parentElement!==i.current)return;t.deleteContents();let a=null;if(typeof e=="string"?(a=document.createTextNode(e),a.textContent=e):C(e)?a=G({componentId:u,tagsDataRef:r,data:e,showTagDeleteBtn:E}):typeof e=="object"&&e.type===v.LINE_BREAK&&(a=document.createElement("br")),!a){console.error("invalid content");return}t.insertNode(a);let x=document.createRange();x.setStartAfter(a),x.setEndAfter(a),c.removeAllRanges(),c.addRange(x),(R=i.current)==null||R.focus(),w.current=((N=i.current)==null?void 0:N.innerHTML)??"";let b=C(e)||q(e)?1:0;T.current+=(((p=a==null?void 0:a.textContent)==null?void 0:p.length)||0)+b,n==null||n(S((m=i.current)==null?void 0:m.childNodes,r))};oe(g,()=>({inputRef:i.current,insertContent:_,getValue:()=>{var e;return S((e=i.current)==null?void 0:e.childNodes,r)}}));let z=()=>{var e;i.current&&(w.current=i.current.innerHTML),n==null||n(S((e=i.current)==null?void 0:e.childNodes,r))},J=e=>{var c,t,a,x,b,R,N;if(V==null||V(e),e.key==="Enter"&&!f)e.preventDefault();else if(e.key==="Enter"&&f){e.preventDefault(),_({type:"line-break"});return}else if(e.key==="Backspace"){let{node:p,charCode:m}=F(O()),y=null;if(((c=p==null?void 0:p.previousSibling)==null?void 0:c.nodeName)==="SPAN"){let M=p==null?void 0:p.previousSibling;y=(t=M.getAttribute)==null?void 0:t.call(M,"data-id")}if(y&&m===8203){e.preventDefault();let M=S((a=i.current)==null?void 0:a.childNodes,r,!0),{label:P}=M.find(I=>C(I)&&(I==null?void 0:I.tagId)===y),X=M.filter(I=>!(C(I)&&I.tagId===y)),Y=D({valueArr:X,componentId:u,showTagDeleteBtn:E,tagsDataRef:r});i!=null&&i.current&&(i.current.innerHTML=Y),L(T.current-P.length-1)}T.current-=1;return}else if(e.key==="ArrowLeft"){let{node:p,charCode:m}=F(T.current),y=p==null?void 0:p.previousSibling,M=(x=y.getAttribute)==null?void 0:x.call(y,"data-id");if(M&&m===8203){e.preventDefault();let P=(b=i.current)==null?void 0:b.querySelector(`[data-id="${M}"]`);L(T.current-(((R=P==null?void 0:P.textContent)==null?void 0:R.length)||0)-1)}return}else if(e.key==="ArrowRight"){let p=T.current+1,{node:m}=F(p);(m==null?void 0:m.nodeName)==="SPAN"&&(e.preventDefault(),L(T.current+(((N=m==null?void 0:m.textContent)==null?void 0:N.length)||0)+1));return}else e.key!=="Delete"&&(T.current+=1)},Q=e=>{var c,t,a;e.target instanceof HTMLButtonElement&&e.target.classList.contains("mtag-delete-btn")&&((t=(c=e.target)==null?void 0:c.parentElement)==null||t.remove(),n==null||n(S((a=i.current)==null?void 0:a.childNodes,r))),l==null||l(e)};function O(){let e=0;if(window.getSelection){let c=window.getSelection();if(i.current&&(c!=null&&c.rangeCount)&&c.rangeCount>0){let t=c.getRangeAt(0),a=t.cloneRange();a.selectNodeContents(i.current),a.setEnd(t.endContainer,t.endOffset),e=a.toString().length}}return e}W(()=>{L(T.current)},[T.current,d]);function L(e){let c=e;if(!i.current)return;let{foundNode:t,nodeIndex:a}=$(i.current,c);if(t!=null&&t.textContent){let x=document.createRange(),b=window.getSelection();if(!b)return;t!=null&&t.textContent&&(t==null?void 0:t.textContent.length)>=c-a?x.setStart(t,c-a):x.setStart(t,t.textContent.length),x.collapse(!0),b.removeAllRanges(),b.addRange(x)}}function F(e){let c=e,{foundNode:t,nodeIndex:a}=$(i.current,c);if(t!=null&&t.textContent){let x=c-a-1,b=t.textContent[x];return{charCode:b==null?void 0:b.charCodeAt(0),node:t,nodeIndex:a,index:x}}return{}}return ne.createElement("div",{"data-placeholder":s,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!A,ref:i,onInput:z,onKeyDown:J,onClick:Q,onSelect:e=>{k==null||k(e),T.current=O()},onPaste:e=>{e.preventDefault();let t=e.clipboardData.getData("text/plain");_(t),h==null||h(e)},onFocus:e=>{L(T.current-1),B==null||B(e)},dangerouslySetInnerHTML:{__html:w.current},...f?{"aria-multiline":!0}:{},...U})}),Z=se;var Ee=Z;export{Ee as default};
//# sourceMappingURL=index.mjs.map