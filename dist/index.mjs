"use client";
import _,{forwardRef as le,useEffect as q,useId as ue,useImperativeHandle as pe,useRef as ce,useState as J}from"react";var H=1,F=3,Z={TAG:"tag",LINE_BREAK:"line-break"};function ie(t){return typeof t=="object"&&t.type===Z.TAG}function ae(t,r){var a,b,m,T;let n=Array.from(t.childNodes),e=r<0;if(!t)return{possibleCaretIndex:void 0,node:void 0,nodeIndex:void 0};if(e)return{possibleCaretIndex:0,node:e?n[0]:void 0,nodeIndex:e?n.length:void 0};let i=0,c=0;for(let d=0;d<n.length;d++){let f=n[d];if(f.nodeType!==H&&f.nodeType!==F){console.error("invalid child node");continue}if(i+=((a=f.textContent)==null?void 0:a.length)||0,f.nodeType===F&&i>=r)return{node:f,possibleCaretIndex:r-c,nodeIndex:d};if(f.nodeType===H&&i>=r)return{node:n[d+1],possibleCaretIndex:1,nodeIndex:d+1};c+=((b=f.textContent)==null?void 0:b.length)||0}return{node:n.at(-1),nodeIndex:n.length-1,possibleCaretIndex:((T=(m=n.at(-1))==null?void 0:m.textContent)==null?void 0:T.length)||0}}function se(t){let r=Object.keys(t);return r.length?r.reduce((n,e)=>n+=`${e}="${t[e]}" `,""):""}function de({props:t,tagClassName:r,showTagDeleteBtn:n}){let{label:e,type:i,class:c,...a}=t;return i!=="tag"?"":`&ZeroWidthSpace;<span class="${r||""} ${c||""}" ${se(a)}contenteditable="false">${e.trim()}${n?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function v(t){return t==null||t===""?!1:t.charCodeAt(0)===8203}function D(t){return t.replace(/[\u200B]/g,"")}function $(t,r,n=!1){var b;if(!t)return;let{node:e,possibleCaretIndex:i}=ae(t,r);n&&((b=e==null?void 0:e.nextSibling)==null?void 0:b.nodeName)==="BR"&&(e=(e==null?void 0:e.nextSibling.nextSibling)||void 0,i=0);let c=document.createRange(),a=window.getSelection();!a||!e||i===void 0||(c.setStart(e,i),c.collapse(!0),a.removeAllRanges(),a.addRange(c))}function O(t){let r={range:void 0,isCaretInSameNode:void 0,endOffset:void 0,startOffset:void 0,startNode:void 0,endNode:void 0};if(!t||!window.getSelection)return r;let n=window.getSelection();if(t&&(n!=null&&n.rangeCount)&&n.rangeCount>0){let e=n.getRangeAt(0);return{range:e,isCaretInSameNode:e.endContainer===e.startContainer,endOffset:e.endOffset,startOffset:e.startOffset,startNode:e.startContainer,endNode:e.endContainer}}return r}function k(t){let r=document.createElement("DIV");return r.innerHTML=t,r.innerText||r.textContent||""}function j(t){let r=document.createElement("div");return r.innerHTML=t,r.innerHTML}function z(t){let r=0;if(window.getSelection){let n=window.getSelection();if(t&&(n!=null&&n.rangeCount)&&n.rangeCount>0){let e=n.getRangeAt(0),i=e.cloneRange();i.selectNodeContents(t),i.setEnd(e.endContainer,e.endOffset),r=i.toString().length}}return r}function B({tagClassName:t,valueArr:r,showTagDeleteBtn:n=!1}){return Array.isArray(r)?r.length?r.reduce((e,i)=>typeof i=="string"?e+=i:ie(i)?e+=de({props:i,showTagDeleteBtn:n,tagClassName:t}):typeof i=="object"&&i.type==="line-break"?e+="<br>":"",""):"":(console.error("[MixTagInput] Wrong value provided"),"")}function G(t,r=""){var i;if(!t)return[];let n=Array.from(t),e=[];for(let c=0;c<n.length;c+=1){let a=n[c],b=e.at(-1);if(a.nodeType===F&&a instanceof Node&&a.textContent!==`
`&&a.textContent!==""&&D(a.textContent||"")!==""){let m=D(a.textContent||"");typeof b=="string"?e[e.length-1]=b+m:e.push(m||"")}if(a.nodeType===H&&a instanceof HTMLElement&&a.nodeName==="SPAN"){let m={};for(let T=0;T<a.attributes.length;T++){let d=a.attributes[T];if(d.nodeName==="class"){let f=(i=d.nodeValue)==null?void 0:i.replaceAll(new RegExp(r,"g"),"").trim();if(f==="")continue;if(f){m[d.nodeName]=f;continue}}d.nodeName!=="contenteditable"&&d.nodeName&&d.nodeValue&&(m[d.nodeName]=d.nodeValue)}e.push({type:Z.TAG,label:a.textContent||"",...m})}a instanceof HTMLElement&&a.nodeName==="BR"&&e.push({type:Z.LINE_BREAK})}return e}function X(t,r){return[t.slice(0,r),t.slice(r)]}var fe=le((t,r)=>{let{onChange:n,onInput:e,onKeyDown:i,onSelect:c,onFocus:a,value:b,multiline:m,placeholder:T,showTagDeleteBtn:d=!1,readonly:f=!1,tagClassName:R="mtag",...U}=t,Y=ue(),[W,ee]=J(""),p=ce(null),[P,y]=J(999);pe(r,()=>({element:p.current,caretPosition:P,insertContent:K})),q(()=>{V({triggerOnchange:!1,newHtmlContent:B({valueArr:b,showTagDeleteBtn:d,tagClassName:R})})},[b,R,d,B]),q(()=>{$(p.current,P)},[P]);let V=({newHtmlContent:s,triggerOnchange:l=!0}={})=>{var I;let o=p.current;if(!o)return;let g=s!==void 0,u=g?j(s):o.innerHTML,x=g?k(u):o.innerText,C=g&&v(W.charAt(1)),S=k(x).length-k(W).length;C&&(S=0);let h=u.startsWith("<span")?"&ZeroWidthSpace;"+u:u;ee(h),C||y(E=>E+S),l&&(n==null||n(G((I=p.current)==null?void 0:I.childNodes,R)))},te=s=>{var C;c==null||c(s);let{endNode:l}=O(p.current),o=l==null?void 0:l.previousSibling,g=l==null?void 0:l.nextSibling,u=(g==null?void 0:g.nodeName)==="SPAN",x=z(p.current);u&&o===null&&x===1&&v((C=l==null?void 0:l.textContent)==null?void 0:C.at(0))?y(0):y(x)},ne=s=>{var A,h,I,E;let l=s.key,{endNode:o,endOffset:g}=O(p.current),u=o==null?void 0:o.previousSibling,x=o==null?void 0:o.nextSibling,C=(x==null?void 0:x.nodeName)==="BR",S=2;if(l==="ArrowLeft"&&o&&u&&v((A=o.textContent)==null?void 0:A.at(g-1))){s.preventDefault();let M=u.nodeName==="BR",w=u.nodeName==="SPAN";M&&y(N=>N-1),w&&y(N=>{var L;return N-((((L=u==null?void 0:u.textContent)==null?void 0:L.length)||0)+S)})}if(l==="ArrowRight"&&o&&x&&v((h=o.textContent)==null?void 0:h.at(g))){s.preventDefault();let M=x.nodeName==="BR",w=x.nodeName==="SPAN";M&&y(N=>N+1),w&&y(N=>{var L;return N+((((L=u==null?void 0:u.textContent)==null?void 0:L.length)||0)+S)})}l==="ArrowRight"&&o&&C&&(s.preventDefault(),y(M=>M+1)),l==="Backspace"&&o&&v((I=o.textContent)==null?void 0:I.at(g-1))&&((E=o.previousSibling)==null?void 0:E.nodeType)===H&&p.current&&(s.preventDefault(),p.current.removeChild(o.previousSibling),o.textContent=D((o==null?void 0:o.textContent)||""),V()),l==="Enter"&&(s.preventDefault(),m&&K({type:"line-break"})),i==null||i(s)},re=s=>{$(p.current,P),a==null||a(s)},oe=s=>{V(),e==null||e(s)};function K(s){var E,M;(M=(E=window.getSelection())==null?void 0:E.anchorNode)==null||M.parentElement,p.current;let l=B({tagClassName:R,showTagDeleteBtn:d,valueArr:Array.isArray(s)?s:[s]}),{endNode:o,endOffset:g}=O(p.current),u=o===p.current;if(!p.current||!o||o==null||o===null)return;let[x,C]=X(o.textContent||"",g),S=document.createTextNode(x),A=document.createTextNode(C),h=document.createDocumentFragment(),I=document.createElement("DIV");I.innerHTML=l,h.append(S),Array.from(I.childNodes).map(w=>h.append(w)),h.append(A),h.normalize(),u?p.current.append(h):p.current.replaceChild(h,o),V()}return _.createElement(_.Fragment,null,_.createElement("div",{key:`${Y}-mix-input`,"data-placeholder":T,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!f,ref:p,onInput:oe,onKeyDown:ne,onSelect:te,onFocus:re,dangerouslySetInnerHTML:{__html:W},...m?{"aria-multiline":!0}:{},...U}))}),Q=fe;var Ie=Q;export{Ie as default};
//# sourceMappingURL=index.mjs.map