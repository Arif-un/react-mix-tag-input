"use client";
import te,{forwardRef as ne,useEffect as F,useId as re,useImperativeHandle as ae,useRef as H}from"react";var K="mtag",S={TAG:"tag",LINE_BREAK:"line-break"};function C(o,g,l=!1){var u,d;if(!o)return[];let r=Array.from(o),n=[];for(let f=0;f<r.length;f+=1){let s=r[f],E=n.at(-1);if(s instanceof Node&&s.nodeName==="#text"&&s.textContent!==`
`&&s.textContent!==""){let y=Y(s.textContent||"");typeof E=="string"?n[n.length-1]=E+y:n.push(y||"")}if(s instanceof HTMLElement&&s.nodeName==="SPAN"){let y=(u=s==null?void 0:s.classList)==null?void 0:u.value.replace(K,"").trim(),h=((d=s==null?void 0:s.dataset)==null?void 0:d.id)||"";n.push({...l?{tagId:h}:{},type:S.TAG,label:s.innerHTML||s.innerText,...y?{classes:y}:{},...g.current[h]?{data:g.current[h]}:{}})}s instanceof HTMLElement&&s.nodeName==="BR"&&n.push({type:S.LINE_BREAK})}return n}function Y(o){return o.replace(/[\u200B]/g,"")}function ee({classes:o,text:g,id:l,showTagDeleteBtn:r}){return`<span data-id="${l}" class="${K} ${o}" contenteditable="false">${g.trim()}${r?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function D({valueArr:o,showTagDeleteBtn:g=!1,tagsDataRef:l,componentId:r}){return!Array.isArray(o)||o.length===0?"":o.reduce((n,u)=>{if(typeof u=="string")return n+=u;if(L(u)){let{label:d,classes:f,data:s}=u,E=j(r);return s&&(l.current[E]=s),n+=ee({classes:f||"",text:d,id:E,showTagDeleteBtn:g})}return typeof u=="object"&&u.type==="line-break"?n+="<br>":""},"")}function j(o){let g=Date.now().toString(36),l=Math.random().toString(36).substr(2);return o+g+l}function G({componentId:o,tagsDataRef:g,showTagDeleteBtn:l,data:r}){let n=document.createElement("span");n.setAttribute("contentEditable","false");let u=j(o);if(n.setAttribute("data-id",u),n.classList.add(K),n.innerHTML=r.label,r.classes&&n.classList.add(r.classes),r.data&&(g.current[u]=r.data,n.setAttribute("data-id",u)),l){let d=document.createElement("button");d.classList.add("mtag-delete-btn"),d.setAttribute("contentEditable","false"),d.setAttribute("tabIndex","-1"),d.innerHTML="&times;",n.appendChild(d)}return n}function $(o,g){var u;if(!o)return{foundNode:void 0,nodeIndex:0};let l=null,r=0,n=Array.from(o.childNodes);for(let d=0;d<n.length;d++){let f=n[d];if(f!=null&&f.textContent){let s=f.textContent.length;if(r+s>=g){l=f;break}r+=s}}return l||(l=n.at(-1),r=((u=l==null?void 0:l.textContent)==null?void 0:u.length)||0),{foundNode:l,nodeIndex:r}}function L(o){return typeof o=="object"&&o.type===S.TAG}function q(o){return typeof o=="object"&&o.type===S.LINE_BREAK}var oe=ne((o,g)=>{let l=re(),r=H({}),{onChange:n,onClick:u,value:d,multiline:f,placeholder:s,showTagDeleteBtn:E=!0,readonly:y=!1,onPaste:h,onKeyDown:V,onSelect:k,...Z}=o,B=H(D({componentId:l,tagsDataRef:r,valueArr:d,showTagDeleteBtn:E})),i=H(null),b=H(0);F(()=>{i.current&&(i.current.innerHTML=D({componentId:l,tagsDataRef:r,valueArr:d,showTagDeleteBtn:E}))},[d]);let w=e=>{var v,R,p,m;let c=window.getSelection();if(!c)return;let t=c.getRangeAt(0);if(t.commonAncestorContainer!==i.current&&t.commonAncestorContainer.parentElement!==i.current)return;t.deleteContents();let a=null;if(typeof e=="string"?(a=document.createTextNode(e),a.textContent=e):L(e)?a=G({componentId:l,tagsDataRef:r,data:e,showTagDeleteBtn:E}):typeof e=="object"&&e.type===S.LINE_BREAK&&(a=document.createElement("br")),!a){console.error("invalid content");return}t.insertNode(a);let x=document.createRange();x.setStartAfter(a),x.setEndAfter(a),c.removeAllRanges(),c.addRange(x),(v=i.current)==null||v.focus(),B.current=((R=i.current)==null?void 0:R.innerHTML)??"";let T=L(e)||q(e)?1:0;b.current+=(((p=a==null?void 0:a.textContent)==null?void 0:p.length)||0)+T,n==null||n(C((m=i.current)==null?void 0:m.childNodes,r))};ae(g,()=>({inputRef:i.current,insertContent:w,getValue:()=>{var e;return C((e=i.current)==null?void 0:e.childNodes,r)}}));let U=()=>{var e;i.current&&(B.current=i.current.innerHTML),n==null||n(C((e=i.current)==null?void 0:e.childNodes,r))},z=e=>{var c,t,a,x,T,v,R;if(V==null||V(e),e.key==="Enter"&&!f)e.preventDefault();else if(e.key==="Enter"&&f){e.preventDefault(),w({type:"line-break"});return}else if(e.key==="Backspace"){let{node:p,charCode:m}=_(O()),M=null;if(((c=p==null?void 0:p.previousSibling)==null?void 0:c.nodeName)==="SPAN"){let A=p==null?void 0:p.previousSibling;M=(t=A.getAttribute)==null?void 0:t.call(A,"data-id")}if(M&&m===8203){e.preventDefault();let A=C((a=i.current)==null?void 0:a.childNodes,r,!0),{label:N}=A.find(I=>L(I)&&(I==null?void 0:I.tagId)===M),Q=A.filter(I=>!(L(I)&&I.tagId===M)),X=D({valueArr:Q,componentId:l,showTagDeleteBtn:E,tagsDataRef:r});i!=null&&i.current&&(i.current.innerHTML=X),P(b.current-N.length-1)}b.current-=1;return}else if(e.key==="ArrowLeft"){let{node:p,charCode:m}=_(b.current),M=p==null?void 0:p.previousSibling,A=(x=M.getAttribute)==null?void 0:x.call(M,"data-id");if(A&&m===8203){e.preventDefault();let N=(T=i.current)==null?void 0:T.querySelector(`[data-id="${A}"]`);P(b.current-(((v=N==null?void 0:N.textContent)==null?void 0:v.length)||0)-1)}return}else if(e.key==="ArrowRight"){let p=b.current+1,{node:m}=_(p);(m==null?void 0:m.nodeName)==="SPAN"&&(e.preventDefault(),P(b.current+(((R=m==null?void 0:m.textContent)==null?void 0:R.length)||0)+1));return}else e.key!=="Delete"&&(b.current+=1)},J=e=>{var c,t,a;e.target instanceof HTMLButtonElement&&e.target.classList.contains("mtag-delete-btn")&&((t=(c=e.target)==null?void 0:c.parentElement)==null||t.remove(),n==null||n(C((a=i.current)==null?void 0:a.childNodes,r))),u==null||u(e)};function O(){let e=0;if(window.getSelection){let c=window.getSelection();if(i.current&&(c!=null&&c.rangeCount)&&c.rangeCount>0){let t=c.getRangeAt(0),a=t.cloneRange();a.selectNodeContents(i.current),a.setEnd(t.endContainer,t.endOffset),e=a.toString().length}}return e}F(()=>{P(b.current)},[b.current,d]);function P(e){let c=e;if(!i.current)return;let{foundNode:t,nodeIndex:a}=$(i.current,c);if(t!=null&&t.textContent){let x=document.createRange(),T=window.getSelection();if(!T)return;t!=null&&t.textContent&&(t==null?void 0:t.textContent.length)>=c-a?x.setStart(t,c-a):x.setStart(t,t.textContent.length),x.collapse(!0),T.removeAllRanges(),T.addRange(x)}}function _(e){let c=e,{foundNode:t,nodeIndex:a}=$(i.current,c);if(t!=null&&t.textContent){let x=c-a-1,T=t.textContent[x];return{charCode:T==null?void 0:T.charCodeAt(0),node:t,nodeIndex:a,index:x}}return{}}return te.createElement("div",{"data-placeholder":s,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!y,ref:i,onInput:U,onKeyDown:z,onClick:J,onSelect:e=>{k==null||k(e),b.current=O()},onPaste:e=>{e.preventDefault();let t=e.clipboardData.getData("text/plain");w(t),h==null||h(e)},dangerouslySetInnerHTML:{__html:B.current},...f?{"aria-multiline":!0}:{},...Z})}),W=oe;var Te=W;export{Te as default};
//# sourceMappingURL=index.mjs.map