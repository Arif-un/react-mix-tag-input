"use client";
import tt,{forwardRef as et,useEffect as q,useId as nt,useImperativeHandle as rt,useRef as H}from"react";var K="mtag",P={TAG:"tag",LINE_BREAK:"line-break"};function C(c,g,l=!1){var u,d;if(!c)return[];let r=Array.from(c),n=[];for(let f=0;f<r.length;f+=1){let o=r[f],E=n.at(-1);if(o instanceof Node&&o.nodeName==="#text"&&o.textContent!==`
`&&o.textContent!==""){let h=X(o.textContent||"");typeof E=="string"?n[n.length-1]=E+h:n.push(h||"")}if(o instanceof HTMLElement&&o.nodeName==="SPAN"){let h=(u=o==null?void 0:o.classList)==null?void 0:u.value.replace(K,"").trim(),y=((d=o==null?void 0:o.dataset)==null?void 0:d.id)||"";n.push({...l?{tagId:y}:{},type:P.TAG,label:o.innerHTML||o.innerText,...h?{classes:h}:{},...g.current[y]?{data:g.current[y]}:{}})}o instanceof HTMLElement&&o.nodeName==="BR"&&n.push({type:P.LINE_BREAK})}return n}function X(c){return c.replace(/[\u200B]/g,"")}function Y({classes:c,text:g,id:l,showTagDeleteBtn:r}){return`<span data-id="${l}" class="${K} ${c}" contenteditable="false">${g.trim()}${r?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function D({valueArr:c,showTagDeleteBtn:g=!1,tagsDataRef:l,componentId:r}){return!Array.isArray(c)||c.length===0?"":c.reduce((n,u)=>{if(typeof u=="string")return n+=u;if(S(u)){let{label:d,classes:f,data:o}=u,E=G(r);return o&&(l.current[E]=o),n+=Y({classes:f||"",text:d,id:E,showTagDeleteBtn:g})}return typeof u=="object"&&u.type==="line-break"?n+="<br>":""},"")}function G(c){let g=Date.now().toString(36),l=Math.random().toString(36).substr(2);return c+g+l}function j({componentId:c,tagsDataRef:g,showTagDeleteBtn:l,data:r}){let n=document.createElement("span");n.setAttribute("contentEditable","false");let u=G(c);if(n.setAttribute("data-id",u),n.classList.add(K),n.innerHTML=r.label,r.classes&&n.classList.add(r.classes),r.data&&(g.current[u]=r.data,n.setAttribute("data-id",u)),l){let d=document.createElement("button");d.classList.add("mtag-delete-btn"),d.setAttribute("contentEditable","false"),d.setAttribute("tabIndex","-1"),d.innerHTML="&times;",n.appendChild(d)}return n}function $(c,g){var u;if(!c)return{foundNode:void 0,nodeIndex:0};let l=null,r=0,n=Array.from(c.childNodes);for(let d=0;d<n.length;d++){let f=n[d];if(f!=null&&f.textContent){let o=f.textContent.length;if(r+o>=g){l=f;break}r+=o}}return l||(l=n.at(-1),r=((u=l==null?void 0:l.textContent)==null?void 0:u.length)||0),{foundNode:l,nodeIndex:r}}function S(c){return typeof c=="object"&&c.type===P.TAG}var at=et((c,g)=>{let l=nt(),r=H({}),{onChange:n,onClick:u,value:d,multiline:f,placeholder:o,showTagDeleteBtn:E=!0,readonly:h=!1,onPaste:y,onKeyDown:V,onSelect:k,...W}=c,w=H(D({componentId:l,tagsDataRef:r,valueArr:d,showTagDeleteBtn:E})),s=H(null),b=H(0);q(()=>{s.current&&(s.current.innerHTML=D({componentId:l,tagsDataRef:r,valueArr:d,showTagDeleteBtn:E}))},[d]);let B=t=>{var v,L,p,m;let i=window.getSelection();if(!i)return;let e=i.getRangeAt(0);if(e.commonAncestorContainer!==s.current&&e.commonAncestorContainer.parentElement!==s.current)return;e.deleteContents();let a=null;if(typeof t=="string"?(a=document.createTextNode(t),a.textContent=t):S(t)?a=j({componentId:l,tagsDataRef:r,data:t,showTagDeleteBtn:E}):typeof t=="object"&&t.type===P.LINE_BREAK&&(a=document.createElement("br")),!a){console.error("invalid content");return}e.insertNode(a);let x=document.createRange();x.setStartAfter(a),x.setEndAfter(a),i.removeAllRanges(),i.addRange(x),(v=s.current)==null||v.focus(),w.current=((L=s.current)==null?void 0:L.innerHTML)??"";let T=S(t)?1:0;b.current+=(((p=a==null?void 0:a.textContent)==null?void 0:p.length)||0)+T,n==null||n(C((m=s.current)==null?void 0:m.childNodes,r))};rt(g,()=>({inputRef:s.current,insertContent:B,getValue:()=>{var t;return C((t=s.current)==null?void 0:t.childNodes,r)}}));let Z=()=>{var t;s.current&&(w.current=s.current.innerHTML),n==null||n(C((t=s.current)==null?void 0:t.childNodes,r))},U=t=>{var i,e,a,x,T,v,L;if(V==null||V(t),t.key==="Enter"&&!f)t.preventDefault();else if(t.key==="Enter"&&f){t.preventDefault(),B({type:"line-break"});return}else if(t.key==="Backspace"){let{node:p,charCode:m}=_(O()),M=null;if(((i=p==null?void 0:p.previousSibling)==null?void 0:i.nodeName)==="SPAN"){let A=p==null?void 0:p.previousSibling;M=(e=A.getAttribute)==null?void 0:e.call(A,"data-id")}if(M&&m===8203){t.preventDefault();let A=C((a=s.current)==null?void 0:a.childNodes,r,!0),{label:R}=A.find(I=>S(I)&&(I==null?void 0:I.tagId)===M),J=A.filter(I=>!(S(I)&&I.tagId===M)),Q=D({valueArr:J,componentId:l,showTagDeleteBtn:E,tagsDataRef:r});s!=null&&s.current&&(s.current.innerHTML=Q),N(b.current-R.length-1)}b.current-=1;return}else if(t.key==="ArrowLeft"){let{node:p,charCode:m}=_(b.current),M=p==null?void 0:p.previousSibling,A=(x=M.getAttribute)==null?void 0:x.call(M,"data-id");if(A&&m===8203){t.preventDefault();let R=(T=s.current)==null?void 0:T.querySelector(`[data-id="${A}"]`);N(b.current-(((v=R==null?void 0:R.textContent)==null?void 0:v.length)||0)-1)}return}else if(t.key==="ArrowRight"){let p=b.current+1,{node:m}=_(p);(m==null?void 0:m.nodeName)==="SPAN"&&(t.preventDefault(),N(b.current+(((L=m==null?void 0:m.textContent)==null?void 0:L.length)||0)+1));return}else t.key!=="Delete"&&(b.current+=1)},z=t=>{var i,e,a;t.target instanceof HTMLButtonElement&&t.target.classList.contains("mtag-delete-btn")&&((e=(i=t.target)==null?void 0:i.parentElement)==null||e.remove(),n==null||n(C((a=s.current)==null?void 0:a.childNodes,r))),u==null||u(t)};function O(){let t=0;if(window.getSelection){let i=window.getSelection();if(s.current&&(i!=null&&i.rangeCount)&&i.rangeCount>0){let e=i.getRangeAt(0),a=e.cloneRange();a.selectNodeContents(s.current),a.setEnd(e.endContainer,e.endOffset),t=a.toString().length}}return t}q(()=>{N(b.current)},[b.current,d]);function N(t){let i=t;if(!s.current)return;let{foundNode:e,nodeIndex:a}=$(s.current,i);if(e!=null&&e.textContent){let x=document.createRange(),T=window.getSelection();if(!T)return;e!=null&&e.textContent&&(e==null?void 0:e.textContent.length)>=i-a?x.setStart(e,i-a):x.setStart(e,e.textContent.length),x.collapse(!0),T.removeAllRanges(),T.addRange(x)}}function _(t){let i=t,{foundNode:e,nodeIndex:a}=$(s.current,i);if(e!=null&&e.textContent){let x=i-a-1,T=e.textContent[x];return{charCode:T==null?void 0:T.charCodeAt(0),node:e,nodeIndex:a,index:x}}return{}}return tt.createElement("div",{"data-placeholder":o,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!h,ref:s,onInput:Z,onKeyDown:U,onClick:z,onSelect:t=>{k==null||k(t),b.current=O()},onPaste:t=>{t.preventDefault();let e=t.clipboardData.getData("text/plain");B(e),y==null||y(t)},dangerouslySetInnerHTML:{__html:w.current},...f?{"aria-multiline":!0}:{},...W})}),F=at;var mt=F;export{mt as default};
//# sourceMappingURL=index.mjs.map