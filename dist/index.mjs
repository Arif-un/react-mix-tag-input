"use client";
import tt,{forwardRef as et,useEffect as q,useId as nt,useImperativeHandle as rt,useRef as H}from"react";var K="mtag",P={TAG:"tag",LINE_BREAK:"line-break"};function S(c,p,l=!1){var u,d;if(!c)return[];let r=Array.from(c),n=[];for(let f=0;f<r.length;f+=1){let o=r[f],A=n.at(-1);if(o instanceof Node&&o.nodeName==="#text"&&o.textContent!==`
`&&o.textContent!==""){let y=X(o.textContent||"");typeof A=="string"?n[n.length-1]=A+y:n.push(y||"")}if(o instanceof HTMLElement&&o.nodeName==="SPAN"){let y=(u=o==null?void 0:o.classList)==null?void 0:u.value.replace(K,"").trim(),E=((d=o==null?void 0:o.dataset)==null?void 0:d.id)||"";n.push({...l?{tagId:E}:{},type:P.TAG,label:o.innerHTML||o.innerText,...y?{classes:y}:{},...p.current[E]?{data:p.current[E]}:{}})}o instanceof HTMLElement&&o.nodeName==="BR"&&n.push({type:P.LINE_BREAK})}return n}function X(c){return c.replace(/[\u200B]/g,"")}function Y({classes:c,text:p,id:l,showTagDeleteBtn:r}){return`<span data-id="${l}" class="${K} ${c}" contenteditable="false">${p.trim()}${r?'<button class="mtag-delete-btn" contenteditable="false" tabindex="-1">\xD7</button>':""}</span>&ZeroWidthSpace;`}function D({valueArr:c,showTagDeleteBtn:p=!1,tagsDataRef:l,componentId:r}){return!Array.isArray(c)||c.length===0?"":c.reduce((n,u)=>{if(typeof u=="string")return n+=u;if(C(u)){let{label:d,classes:f,data:o}=u,A=G(r);return o&&(l.current[A]=o),n+=Y({classes:f||"",text:d,id:A,showTagDeleteBtn:p})}return typeof u=="object"&&u.type==="line-break"?n+="<br>":""},"")}function G(c){let p=Date.now().toString(36),l=Math.random().toString(36).substr(2);return c+p+l}function j({componentId:c,tagsDataRef:p,showTagDeleteBtn:l,data:r}){let n=document.createElement("span");n.setAttribute("contentEditable","false");let u=G(c);if(n.setAttribute("data-id",u),n.classList.add(K),n.innerHTML=r.label,r.classes&&n.classList.add(r.classes),r.data&&(p.current[u]=r.data,n.setAttribute("data-id",u)),l){let d=document.createElement("button");d.classList.add("mtag-delete-btn"),d.setAttribute("contentEditable","false"),d.setAttribute("tabIndex","-1"),d.innerHTML="&times;",n.appendChild(d)}return n}function $(c,p){var u;if(!c)return{foundNode:void 0,nodeIndex:0};let l=null,r=0,n=Array.from(c.childNodes);for(let d=0;d<n.length;d++){let f=n[d];if(f!=null&&f.textContent){let o=f.textContent.length;if(r+o>=p){l=f;break}r+=o}}return l||(l=n.at(-1),r=((u=l==null?void 0:l.textContent)==null?void 0:u.length)||0),{foundNode:l,nodeIndex:r}}function C(c){return typeof c=="object"&&c.type===P.TAG}var at=et((c,p)=>{let l=nt(),r=H({}),{onChange:n,onClick:u,value:d,multiline:f,placeholder:o,showTagDeleteBtn:A=!0,readonly:y=!1,onPaste:E,onKeyDown:V,onSelect:k,...W}=c,w=H(D({componentId:l,tagsDataRef:r,valueArr:d,showTagDeleteBtn:A})),s=H(null),T=H(0);q(()=>{s.current&&(s.current.innerHTML=D({componentId:l,tagsDataRef:r,valueArr:d,showTagDeleteBtn:A}))},[d]);let B=t=>{var v,L,g,m;let i=window.getSelection();if(!i)return;let e=i.getRangeAt(0);if(e.commonAncestorContainer!==s.current&&e.commonAncestorContainer.parentElement!==s.current)return;e.deleteContents();let a=null;if(typeof t=="string"?(a=document.createTextNode(t),a.textContent=t):C(t)?a=j({componentId:l,tagsDataRef:r,data:t,showTagDeleteBtn:A}):typeof t=="object"&&t.type===P.LINE_BREAK&&(a=document.createElement("br")),!a){console.error("invalid content");return}e.insertNode(a);let x=document.createRange();x.setStartAfter(a),x.setEndAfter(a),i.removeAllRanges(),i.addRange(x),(v=s.current)==null||v.focus(),w.current=((L=s.current)==null?void 0:L.innerHTML)??"";let b=C(t)?1:0;T.current+=(((g=a==null?void 0:a.textContent)==null?void 0:g.length)||0)+b,n==null||n(S((m=s.current)==null?void 0:m.childNodes,r))};rt(p,()=>({inputRef:s.current,insertContent:B,getValue:()=>{var t;return S((t=s.current)==null?void 0:t.childNodes,r)}}));let Z=()=>{var t;s.current&&(w.current=s.current.innerHTML),n==null||n(S((t=s.current)==null?void 0:t.childNodes,r))},U=t=>{var i,e,a,x,b,v,L;if(V==null||V(t),t.key==="Enter"&&!f)t.preventDefault();else if(t.key==="Enter"&&f){t.preventDefault(),B({type:"line-break"});return}else if(t.key==="Backspace"){let{node:g,charCode:m}=_(O()),h=null;if(((i=g==null?void 0:g.previousSibling)==null?void 0:i.nodeName)==="SPAN"){let M=g==null?void 0:g.previousSibling;h=(e=M.getAttribute)==null?void 0:e.call(M,"data-id")}if(h&&m===8203){t.preventDefault();let M=S((a=s.current)==null?void 0:a.childNodes,r,!0),{label:R}=M.find(I=>C(I)&&(I==null?void 0:I.tagId)===h),J=M.filter(I=>!(C(I)&&I.tagId===h)),Q=D({valueArr:J,componentId:l,showTagDeleteBtn:A,tagsDataRef:r});s!=null&&s.current&&(s.current.innerHTML=Q),N(T.current-R.length-1)}T.current-=1;return}else if(t.key==="ArrowLeft"){let{node:g,charCode:m}=_(T.current),h=g==null?void 0:g.previousSibling,M=(x=h.getAttribute)==null?void 0:x.call(h,"data-id");if(M&&m===8203){t.preventDefault();let R=(b=s.current)==null?void 0:b.querySelector(`[data-id="${M}"]`);N(T.current-(((v=R==null?void 0:R.textContent)==null?void 0:v.length)||0)-1)}return}else if(t.key==="ArrowRight"){let g=T.current+1,{node:m}=_(g);(m==null?void 0:m.nodeName)==="SPAN"&&(t.preventDefault(),N(T.current+(((L=m==null?void 0:m.textContent)==null?void 0:L.length)||0)+1));return}else t.key!=="Delete"&&(T.current+=1)},z=t=>{var i,e,a;t.target instanceof HTMLButtonElement&&t.target.classList.contains("mtag-delete-btn")&&((e=(i=t.target)==null?void 0:i.parentElement)==null||e.remove(),n==null||n(S((a=s.current)==null?void 0:a.childNodes,r))),u==null||u(t)};function O(){let t=0;if(window.getSelection){let i=window.getSelection();if(s.current&&(i!=null&&i.rangeCount)&&i.rangeCount>0){let e=i.getRangeAt(0),a=e.cloneRange();a.selectNodeContents(s.current),a.setEnd(e.endContainer,e.endOffset),t=a.toString().length}}return t}q(()=>{N(T.current)},[T.current,d]);function N(t){let i=t;if(!s.current)return;let{foundNode:e,nodeIndex:a}=$(s.current,i);if(e!=null&&e.textContent){let x=document.createRange(),b=window.getSelection();if(!b)return;e!=null&&e.textContent&&(e==null?void 0:e.textContent.length)>=i-a?x.setStart(e,i-a):x.setStart(e,e.textContent.length),x.collapse(!0),b.removeAllRanges(),b.addRange(x)}}function _(t){let i=t,{foundNode:e,nodeIndex:a}=$(s.current,i);if(e!=null&&e.textContent){let x=i-a-1,b=e.textContent[x];return{charCode:b==null?void 0:b.charCodeAt(0),node:e,nodeIndex:a,index:x}}return{}}return tt.createElement("div",{"data-placeholder":o,"aria-label":"input",role:"textbox",tabIndex:0,className:"mix-tag-input",contentEditable:!y,ref:s,onInput:Z,onKeyDown:U,onClick:z,onSelect:t=>{k==null||k(t),T.current=O(),console.log("cursor pos",T.current)},onPaste:t=>{t.preventDefault();let e=t.clipboardData.getData("text/plain");B(e),E==null||E(t)},dangerouslySetInnerHTML:{__html:w.current},...f?{"aria-multiline":!0}:{},...W})}),F=at;var mt=F;export{mt as default};
//# sourceMappingURL=index.mjs.map